{% extends 'main.html' %}

{% block content %}
{% if messages %}
    {% for message in messages %}
        <div class="alert {% if message.tags == 'error' %}alert-danger{% elif message.tags == 'success' %}alert-success{% else %}alert-primary{% endif %}">
            {{ message }}
        </div>
    {% endfor %}
{% endif %}
<!-- content @s -->
<div class="nk-content ">
    <div class="container-fluid">
        <div class="nk-content-inner">  
            
            <div class="nk-content-body">
                <div class="nk-block-head nk-block-head-sm">
                    <div class="nk-block-between g-3">
                        <div class="nk-block-head-content">
                            <h3 class="nk-block-title page-title">{{loan.loan_id}} / <strong class="text-primary small">{{loan.member.first_name}} {{loan.member.last_name}}</strong></h3>
                            <div class="nk-block-des text-soft">
                                <ul class="list-inline">
                                    {% if loan.status != 'pending' %}
                                    <li>Total Payable: <span class="text-base">{{loan.total_payable}}</span></li>
                                    <li>Loan Balance: <span class="text-base">{{loan.loan_balance}}</span></li>
                                    {% endif %}
                                    {% if loan.status == 'pending' %}
                                    <li>Applied Amount: <span class="text-base">{{loan.applied_amount}} {{company_currency}}</span></li>
                                    <li>Recommended Amount: <span class="text-base">{{loan.final_reco_amount}}</span></li>
                                    {% endif %}
                                </ul>
                            </div>
                        </div>
                        <div class="nk-block-head-content">
                            <a href="{% url 'loans' %}" class="btn btn-outline-light bg-white d-none d-sm-inline-flex"><em class="icon ni ni-arrow-left"></em><span>Back</span></a>
                            <a href="html/user-list-regular.html" class="btn btn-icon btn-outline-light bg-white d-inline-flex d-sm-none"><em class="icon ni ni-arrow-left"></em></a>
                        </div>
                    </div>
                </div><!-- .nk-block-head -->
                <div class="card card-bordered card-preview">
                    <div class="card-inner">
                        <div class="row g-gs">
                            <div class="col-md-4">
                                <ul class="nav link-list-menu border border-light round m-0">
                                    <li>
                                        <a class="active" data-bs-toggle="tab" href="#loanDetails"><em class="icon ni ni-coin"></em><span>Loan Details</span></a>
                                    </li>
                                    <li>
                                        <a data-bs-toggle="tab" href="#guarantorDetails"><em class="icon ni ni-user-circle"></em><span>Guarantor</span></a>
                                    </li>
                                    <li>
                                        <a data-bs-toggle="tab" href="#collateralDetails"><em class="icon ni ni-coins"></em><span>Collateral</span></a>
                                    </li>
                                    <li>
                                        <a data-bs-toggle="tab" href="#mpesaStatement"><em class="icon ni ni-coins"></em><span>Mpesa Statement</span></a>
                                    </li>
                                    {% if loan.status != 'pending' and loan.status != 'rejected' %}
                                    <li>
                                        <a data-bs-toggle="tab" href="#repaymentDetails"><em class="icon ni ni-tranx-fill"></em><span>Repayments</span></a>
                                    </li>
                                    {% endif %}
                                    <li>
                                        <a data-bs-toggle="tab" href="#analysis"><em class="icon ni ni-wallet-in"></em><span>Analysis</span></a>
                                    </li> 
                                    {% if loan.parent_loan %}
                                    <li>
                                        <a  href="{% url 'view-loan' loan.parent_loan.id %}" class="btn btn-sm btn-primary btn-dim">View Parent Loan</a>
                                    </li>
                                    {% endif %}
                                </ul> <br>
                                <ul class="list-inline">
                                    {% if loan.status == 'overdue' or loan.status == 'approved' %}
                                    <li class="list-inline-item">
                                        <a  href="{% url 'roll-over' loan.id %}" class="btn btn-sm btn-primary btn-dim">Roll Over Loan</a>
                                    </li>
                                    {% endif %}
                                    {% if loan.status == 'overdue' %}
                                    <li class="list-inline-item">
                                        <a  href="{% url 'write-off' loan.id %}" class="btn btn-sm btn-secondary btn-dim">Write Off Loan</a>
                                    </li>
                                    {% endif %}
                                </ul>
                            </div>
                            <div class="col-md-8">
                                <div class="tab-content">
                                    <div class="tab-pane active" id="loanDetails">
                                        <div class="nk-block-head">
                                            <h5 class="title">Loan Information</h5>
                                        </div><!-- .nk-block-head -->
                                        <table class="table table-hover">
                                            <tbody>
                                            <tr>
                                                <td class="profile-ud-label">Loan Type:</td>
                                                <td class="profile-ud-value">{{loan.loan_product.loan_product_name}}</td>
                                            </tr>
                                            <tr>
                                                <td class="profile-ud-label">Loan No:</td>
                                                <td class="profile-ud-value">{{loan.loan_id}}</td>
                                            </tr>
                                            <tr>
                                                <td class="profile-ud-label">Borrower:</td>
                                                <td class="profile-ud-value">{{loan.member.first_name}} {{loan.member.last_name}}</td>
                                            </tr>
                                            <tr>
                                                <td class="profile-ud-label">Applied Amount:</td>
                                                <td class="profile-ud-value text-soft">{{loan.applied_amount}} {{company_currency}} </td>
                                            </tr>
                                            <tr>
                                                <td class="profile-ud-label">Member Tel:</td>
                                                <td class="profile-ud-value">{{loan.member.phone_no}}</td>
                                            </tr>
                                            <tr>
                                                <td class="profile-ud-label">Loan Officer:</td>
                                                <td class="profile-ud-value">{{loan.loan_officer}}</td>
                                            </tr>
                                            <tr>
                                                <td class="profile-ud-label">Status:</td>
                                                {% if loan.status == 'pending' %}
                                                <td class="profile-ud-value text-warning">{{loan.status.upper}}</td>
                                                {% elif loan.status == 'cleared' %}
                                                <td class="profile-ud-value text-success">{{loan.status.upper}}</td>
                                                {% elif loan.status == 'approved' %}
                                                <td class="profile-ud-value text-primary ">{{loan.status.upper}}</td>
                                                {% else %}
                                                <td class="profile-ud-value text-danger">{{loan.status.upper}}</td>
                                                {% endif %}
                                            </tr>
                                        {% if loan.status != 'pending' and loan.status != 'rejected' %}
                                            <tr>
                                                <td class="profile-ud-label">Approved Amount:</td>
                                                <td class="profile-ud-value">{{loan.approved_amount}} {{company_currency}} </td>
                                            </tr>
                                            {% if loan.status == 'overdue' %}
                                            <tr>
                                                <td class="profile-ud-label">Amount Due:</td>
                                                <td class="profile-ud-value text-danger "> {{loan.due_amount}} {{company_currency}} </td>
                                            </tr>
                                            {% endif %}
                                            <tr>
                                                <td class="profile-ud-label">Total Payable:</td>
                                                <td class="profile-ud-value"> {{loan.total_payable}} {{company_currency}} </td>
                                            </tr>
                                            <tr>
                                                <td class="profile-ud-label">No. of Installments:</td>
                                                <td class="profile-ud-value">{{loan.num_installments}} </td>
                                            </tr>
                                            <tr>
                                                <td class="profile-ud-label">Amount per Installment:</td>
                                                <td class="profile-ud-value">{{loan.due_amount}} {{company_currency}} </td>
                                            </tr>
                                            <tr>
                                                <td class="profile-ud-label">Loan Balance:</td>
                                                <td class="profile-ud-value">{{loan.loan_balance}} {{company_currency}} </td>
                                            </tr>
                                            <tr>
                                                <td class="profile-ud-label">Approved By:</td>
                                                <td class="profile-ud-value">{{loan.approved_by}}</td>
                                            </tr>
                                            {% if loan.status == 'overdue' %}
                                            <tr>
                                                <td class="profile-ud-label">Date Due:</td>
                                                <td class="profile-ud-value text-danger">{{loan.due_date.date}}</td>
                                            </tr>
                                            {% elif loan.status == 'approved' %}
                                            <tr>
                                                <td class="profile-ud-label">Date Due:</td>
                                                <td class="profile-ud-value ">{{loan.due_date.date}}</td>
                                            </tr>
                                            {% endif%}
                                            <tr>
                                                <td class="profile-ud-label">Date Approved:</td>
                                                <td class="profile-ud-value">{{loan.approved_date.date}}</td>
                                            </tr>
                                            <tr>
                                                <td class="profile-ud-label">Disbursement Date:</td>
                                                <td class="profile-ud-value">{{loan.approved_date.date}}</td>
                                            </tr>
                                            <tr>
                                                <td class="profile-ud-label">Next Payment Date:</td>
                                                <td class="profile-ud-value">{{loan.next_payment_date.date}}</td>
                                            </tr>
                                            <tr>
                                                <td class="profile-ud-label">Final Payment Date:</td>
                                                <td class="profile-ud-value">{{loan.final_payment_date.date}}</td>
                                            </tr>
                                        {% endif %}
                                            </tbody>
                                        </table><br>
                                        {% if loan.status == 'pending' %}
                                        <div class="row justify-content-center">
                                            <div class="col-md-4 text-center">
                                              <a  href="{% url 'edit-loan' loan.id %}" class="btn btn-primary">Edit Details</a>
                                            </div>
                                        </div>                                          
                                    {% endif %}
                                    </div>
                                    <div class="tab-pane" id="guarantorDetails">
                                        <div class="nk-block nk-block-lg">
                                            <div class="nk-block-head nk-block-head">
                                                <div class="nk-block-head-content">
                                                    <h4 class="nk-block-title">Guarantor Details</h4>
                                                    <div class="nk-block-des d-flex justify-content-between align-items-center">
                                                        <p>Total guarantor score should be above 8 points of credit score</p>
                                                        {% if loan.status == 'pending' %}
                                                            <a data-bs-toggle="modal" href="#addGuarantor" class="btn btn-primary ml-auto btn-sm ">+ Add Guarantor</a>
                                                        {% endif %}
                                                    </div>
                                                    {% if loan.total_guarantor_score < 8 %}
                                                    <div class="alert alert-icon alert-warning" role="alert">
                                                        <em class="icon ni ni-alert-circle"></em> 
                                                        <strong>No guarantor(s) added or their credit score is low.</strong>Add/Change guarantor.  
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <div class="card card-bordered card-preview">
                                                <div class="card-inner">
                                                    <table class="table table-bordered">
                                                        <thead>
                                                            <tr>
                                                                <th scope="col">Name</th>
                                                                <th scope="col">C.Score</th>
                                                                <th scope="col">Tel No.</th>
                                                                <th scope="col">Amount</th>
                                                                {% if loan.status == 'pending' %}
                                                                <th scope="col">Action</th>
                                                                {% endif %}
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {% for guarantor in guarantors %}
                                                            <tr>
                                                              <th scope="row">{{guarantor.name.first_name}} {{guarantor.name.last_name}}</th>
                                                              <td>{{guarantor.name.credit_score}}</td>
                                                              <td>{{guarantor.name.phone_no}}</td>
                                                              <td>{{guarantor.amount}}</td>
                                                              {% if loan.status == 'pending' %}
                                                              <td><a data-bs-toggle="modal" href="#removeGuarantor" data-pk="{{ guarantor.id }}" data-loan_id="{{ loan.id }}" class=" delete-button btn btn-dim btn-danger btn-sm">Remove</a></td>
                                                              {% endif %}
                                                            </tr>
                                                            {% endfor %}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div><!-- .card-preview -->
                                        </div>
                                    </div>
                                    <div class="tab-pane" id="collateralDetails">
                                        <div class="nk-block nk-block-lg">
                                            <div class="nk-block-head nk-block-head">
                                                <div class="nk-block-head-content">
                                                    <h4 class="nk-block-title">Collateral Details</h4>
                                                    <div class="nk-block-des d-flex justify-content-between align-items-center">
                                                        <p>Total collateral value should be above 4 times of applied amount</p>
                                                        {% if loan.status == 'pending' %}
                                                            <a data-bs-toggle="modal" href="#addCollateral" class="btn btn-primary ml-auto btn-sm ">+ Add collateral</a>
                                                        {% endif %}
                                                    </div>
                                                    {% if loan.collateral_value < loan.final_amount_thrice or loan.collateral_value == 0 %}
                                                    <div class="alert alert-icon alert-warning" role="alert">
                                                        <em class="icon ni ni-alert-circle"></em> 
                                                        <strong>No collateral(s) added or their value is insufficient.</strong>Add collateral.  
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <div class="card card-bordered card-preview">
                                                <div class="card-inner">
                                                    <table class="table table-bordered">
                                                        <thead>
                                                            <tr>
                                                                <th scope="col">Name</th>
                                                                <th scope="col">Type</th>
                                                                <th scope="col">S/Number</th>
                                                                <th scope="col"> E.Value</th>
                                                                {% if loan.status == 'pending' %}
                                                                <th scope="col">Action</th>
                                                                {% endif %}
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {% for collateral in collaterals %}
                                                            <tr>
                                                              <th scope="row">{{collateral.name}}</th>
                                                              <td>{{collateral.type}}</td>
                                                              <td>{{collateral.serial_number}}</td>
                                                              <td>{{collateral.estimated_value}}</td>
                                                              <td>
                                                                  {% if loan.status == 'pending' %}
                                                                  <div class="dropdown">
                                                                      <a href="#" class="btn btn-sm btn-primary" data-bs-toggle="dropdown"><span>Action</span><em class="icon ni ni-chevron-down"></em></a>
                                                                      <div class="dropdown-menu dropdown-menu-end dropdown-menu-auto mt-1">
                                                                          <ul class="link-list-plain">
                                                                              <li><a data-bs-toggle="modal" href="#editCollateral" class="btn btn-sm btn-dim btn-secondary">Edit</a></li>
                                                                              <li><a data-bs-toggle="modal" href="#removeCollateral" data-pk="{{ collateral.id }}" data-loan_id="{{ loan.id }}" class=" delete-button btn btn-dim btn-danger">Remove</a></li>
                                                                          </ul>
                                                                      </div>
                                                                  </div>
                                                                  {% endif %}
                                                              </td>    
                                                            </tr>
                                                            {% endfor %}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div><!-- .card-preview -->
                                        </div>
                                    </div>
                                    <div class="tab-pane" id="mpesaStatement">
                                        <div class="nk-block nk-block-lg">
                                            <div class="nk-block-head nk-block-head">
                                                <div class="nk-block-head-content">
                                                    <h4 class="nk-block-title">Mpesa Statement</h4>
                                                    <div class="nk-block-des d-flex justify-content-between align-items-center">
                                                        <p>Add and analyse Mpesa statement.</p>
                                                        {% if loan.status == 'pending' %}
                                                            <a data-bs-toggle="modal" href="#addStatement" class="btn btn-primary ml-auto btn-sm ">+ Add Statement</a>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="nk-divider divider md"></div>
                                            {% for statement in statements %}
                                            <form action="{% url 'analyse-statement' loan.id %}" method="post">
                                                {% csrf_token %}
                                                <div class="form-control-wrap">
                                                    <div class="input-group">
                                                        <input type="text" class="form-control" placeholder="Add a statement" value="{{statement.statements}}" readonly>
                                                        <input type="text" class="form-control" name="statement_id" value="{{statement.id}}" hidden>
                                                        <div class="input-group-append">
                                                            <button type="submit" class="btn btn-outline-primary btn-dim">Analyse Statement</button>
                                                        </div>
                                                    </div>
                                                </div> 
                                            </form> 
                                            {% endfor %} 
                                        </div>                                     
                                    </div>
                                    {% if loan.status != 'pending' and loan.status != 'rejected' %}
                                    <div class="tab-pane" id="repaymentDetails">
                                        <div class="nk-block nk-block-lg">
                                            <div class="nk-block-head nk-block-head">
                                                <div class="nk-block-head-content">
                                                    <h4 class="nk-block-title">Repaymemt Details</h4>
                                                    <div class="nk-block-des d-flex justify-content-between align-items-center">
                                                        <p>These are the repayments made since disbursement of this loan</p>
                                                        {% if loan.status != 'pending' and loan.status != 'rejected' %}
                                                            <a data-bs-toggle="modal" href="#addRepayment" class="btn btn-primary ml-auto btn-sm ">+ Add Repayment</a>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="card card-bordered card-preview">
                                                <div class="card-inner">
                                                    <table class="table table-bordered">
                                                        <thead>
                                                            <tr>
                                                                <th scope="col">Date</th>
                                                                <th scope="col">Amount Paid</th>
                                                                <th scope="col">Loan Balance</th>
                                                                <th scope="col">Action</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {% for repayment in repayments %}
                                                            <tr>
                                                            <th scope="row">{{repayment.date_paid.date}}</th>
                                                            <td>{{repayment.amount}}</td>
                                                            <td>{{loan_balance}}</td>
                                                            {% if loan.status != 'cleared' %}
                                                            <td>
                                                                <div class="dropdown">
                                                                    <a href="#" class="btn btn-sm btn-primary" data-bs-toggle="dropdown"><span>Action</span><em class="icon ni ni-chevron-down"></em></a>
                                                                    <div class="dropdown-menu dropdown-menu-end dropdown-menu-auto mt-1">
                                                                        <ul class="link-list-plain">
                                                                            <li><a data-bs-toggle="modal" href="#editCollateral" class="btn btn-sm btn-dim btn-secondary">Edit</a></li>
                                                                            <li><a data-bs-toggle="modal" href="#editCollateral" class="btn btn-sm btn-dim btn-danger">Remove</a></li>
                                                                        </ul>
                                                                    </div>
                                                                </div>
                                                            </td>  
                                                            {% endif %}  
                                                            </tr>
                                                            {% endfor %}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div><!-- .card-preview -->
                                        </div>
                                    </div>
                                    {% endif %}
                                    <div class="tab-pane" id="analysis">
                                        <div class="nk-block nk-block-lg">
                                            <div class="nk-block-head nk-block-head">
                                                <div class="nk-block-head-content">
                                                    <h4 class="nk-block-title">Loan Analysis</h4>
                                                    <div class="nk-block-des">
                                                        <p>This is the detailed loan analysis.</p>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="card card-bordered card-preview">
                                                <div class="card-inner">
                                                    <table class="table table-bordered">
                                                        <thead>
                                                            <tr>
                                                                <th scope="col">Module</th>
                                                                <th scope="col">Value</th>
                                                                <th scope="col">Status</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <tr>
                                                                <th scope="row">Guarantor(s) Credit Score</th>
                                                                <td>{{ loan.total_guarantor_score }}</td>
                                                                {% if loan.total_guarantor_score < 8 %}
                                                                <td> <span class="badge bg-outline-danger"><em class="icon ni ni-cross-circle-fill"></em>FAILED</span></td>
                                                                {% else %}
                                                                <td> <span class="badge bg-outline-success"><em class="icon ni ni-check-circle-fill"></em>OK</span></td>
                                                                {% endif %}
                                                            </tr>
                                                            <tr>
                                                                <th scope="row">Collateral Value</th>
                                                                <td>{{loan.collateral_value}}</td>
                                                                {% if loan.collateral_value < loan.final_amount_thrice or loan.collateral_value == 0 %}
                                                                <td> <span class="badge bg-outline-danger"><em class="icon ni ni-cross-circle-fill"></em>FAILED</span></td>
                                                                {% else %}
                                                                <td> <span class="badge bg-outline-success"><em class="icon ni ni-check-circle-fill"></em>OK</span></td>
                                                                {% endif %}
                                                            </tr>
                                                            <tr>
                                                                <th scope="row">Borrower Credit Score</th>
                                                                <td>{{loan.member.credit_score}}</td>
                                                                {% if loan.member.credit_score < 5 %}
                                                                <td> <span class="badge bg-outline-danger"><em class="icon ni ni-cross-circle-fill"></em>FAILED</span></td>
                                                                {% else %}
                                                                <td> <span class="badge bg-outline-success"><em class="icon ni ni-check-circle-fill"></em>OK</span></td>
                                                                {% endif %}
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div><!-- .card-preview -->
                                            <div class="nk-block-head nk-block-head">
                                                <div class="nk-block-head-content">
                                                    <h5 class="nk-block-title">Recommended Principal Amount </h5>
                                                    <div class="nk-block-des">
                                                        <span>This data is generated from customer credit history, Mpesa statement analysis and loan form. This should give you good intel on how much you should approved.</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="card card-bordered card-preview"> 
                                                <div class="card-inner">
                                                    <table class="table table-bordered">
                                                        <thead>
                                                            <tr>
                                                                <th scope="col">Module</th>
                                                                <th scope="col">Value</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <tr>
                                                                <th scope="row">Applied Amount</th>
                                                                <td>{{loan.applied_amount}}</td>
                                                            </tr>
                                                            <tr>
                                                                <th scope="row">Recommended Amount Based on Member C.S</th>
                                                                <td>{{loan.amount_based_cs}}</td>
                                                            </tr>
                                                            <tr>
                                                                <th scope="row">Recommended Amount Based on Mpesa Statement Analysis</th>
                                                                <td>{{loan.amount_mpesa_s}}</td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div><br>
                                            {% if loan.status == 'pending' %}
                                                <div class="card card-bordered">
                                                    <div class="card-inner">
                                                        <div class="card-head">
                                                            <h6 class="card-title">Final Recommended Amount: <span>{{loan.final_reco_amount}}</span></h6>
                                                            {% if loan.final_reco_amount < loan.loan_product.minimum_amount %}
                                                            <div class="alert alert-icon alert-warning" role="alert">
                                                                <em class="icon ni ni-alert-circle"></em> 
                                                                <strong>Recommended amount is less than loan minimum amount</strong>. We advice to ask the borrower to provide more business/financial data or reject the loan. 
                                                            </div>
                                                            <div class="form-group mt-2">
                                                                <a data-bs-toggle="modal" href="#rejectLoan" class="btn btn-sm btn-danger btn-dim">Reject</a>
                                                            </div>
                                                            {% else %}
                                                        </div>
                                                        <form action="{% url 'approve' loan.id %}" class="gy-3" method="POST">
                                                            {% csrf_token %}
                                                            <div class="row g-3 align-center">
                                                                <div class="col-lg-5">
                                                                    <div class="form-group">
                                                                        <label class="form-label" for="site-name">Approved Amount</label>
                                                                        <span class="form-note">Change amount or approve as it is.</span>
                                                                    </div>
                                                                </div>
                                                                <div class="col-lg-7">
                                                                    <div class="form-group">
                                                                        <div class="form-control-wrap">
                                                                            <input type="number" name="approved_amount" class="form-control"  value="{{loan.final_reco_amount}}" required>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="row g-3">
                                                                <div class="col-lg-7 offset-lg-5">
                                                                    <div class="form-group mt-2">
                                                                        <button type="submit" class="btn btn-sm btn-primary">Approve</button>
                                                                        <a data-bs-toggle="modal" href="#rejectLoan" class="btn btn-sm btn-danger btn-dim">Reject</a>
                                                                    </div>
                                                                 {% endif %}   
                                                                </div>
                                                            </div>
                                                        </form>
                                                        
                                                    </div>
                                                </div><!-- card -->
                                            {% endif %}
                                           <!-- </div> .card-preview -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="nk-divider divider md"></div>
                        <!--Loan notes Section-->
                        <div class="nk-block">
                            <div class="nk-block-head nk-block-head-sm nk-block-between">
                                <h5 class="title">Notes</h5>
                                <a href="#" class="link link-sm">.</a>
                            </div><!-- .nk-block-head -->
                            <form action=" " method="POST">
                                {% csrf_token %}
                                <div class="form-control-wrap">
                                    <div class="input-group">
                                        <input type="text" class="form-control" name="body" placeholder="Jot some notes about this loan...">
                                        <div class="input-group-append">
                                            <button type="submit" class="btn btn-outline-primary btn-dim">+ Add Note</button>
                                        </div>
                                    </div>
                                </div>
                            </form>
                            <br>
                            <br>
                            <div class="bq-note">
                                {% for note in loan_notes %}
                                <div class="bq-note-item">
                                    <div class="bq-note-text">
                                        <span class='fs-12px'>{{note.body}}</span>
                                    </div>
                                    <div class="bq-note-meta">
                                        <span class="bq-note-added fs-10px">Added <span class="date fs-10px">{{note.created|timesince}}</span> ago </span>
                                        <span class="bq-note-sep sep">|</span>
                                        <span class="bq-note-by fs-10px">By <span class="fs-10px">{{note.author}}</span></span>
                                        {% if request.user == note.author%}
                                        <a href="#" class="link link-sm link-danger">Delete Note</a>
                                        {% endif %}
                                    </div>
                                </div><!-- .bq-note-item -->
                                {% endfor %}
                            </div><!-- .bq-note -->  
                        </div><!-- .nk-block -->
                    </div>
                </div><!-- .card-preview -->
            </div>
        </div>
    </div>
</div>
<!-- content @e -->

<!-- modals -->
<div class="modal fade" id="addStatement">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <a href="#" class="close" data-bs-dismiss="modal" aria-label="Close">
                <em class="icon ni ni-cross-sm"></em>
            </a>
            <div class="modal-body modal-body-md">
                <h5 class="modal-title">Add MPesa Statement </h5><br>
            
                <form action="{% url 'add-statement' loan.id %}" class="form-validate" method="POST" enctype="multipart/form-data" >
                    {% csrf_token %}
                    <div class="row g-4">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label" for="fv-phone">Mpesa Statement</label>
                                <div class="form-control-wrap">
                                    <div class="input-group">
                                        {{form_statement.statements}}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label" for="fv-phone">Passcode</label>
                                <div class="form-control-wrap">
                                    <div class="input-group">
                                        {{form_statement.code}}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="form-group">
                                <button type="submit" class="btn btn-lg btn-primary">Save</button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div><!-- .Add Guarantor Modal-Content -->
<div class="modal fade" id="addGuarantor">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <a href="#" class="close" data-bs-dismiss="modal" aria-label="Close">
                <em class="icon ni ni-cross-sm"></em>
            </a>
            <div class="modal-body modal-body-md">
                <h5 class="modal-title">Add Guarantor </h5><br>
            
                <form action="{% url 'add-guarantor' pk=loan.id %}" class="form-validate" method="POST" enctype="multipart/form-data" >
                    {% csrf_token %}
                    <div class="row g-4">
                        <div class="col-lg-6">
                            <div class="form-group">
                                <label class="form-label" for="full-name-1">Guarantor</label>
                                <div class="form-control-wrap">
                                    {{form.name}}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label" for="fv-phone">Amount</label>
                                <div class="form-control-wrap">
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text" id="fv-phone">{{company_currency}}</span>
                                        </div>
                                        {{form.amount}}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="form-group">
                                <button type="submit" class="btn btn-lg btn-primary">Save</button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div><!-- .Add Guarantor Modal-Content -->
<!-- <div class="modal fade" id="removeGuarantor"> -->
<div class="modal fade" id="approveLoan">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <a href="#" class="close" data-bs-dismiss="modal"><em class="icon ni ni-cross"></em></a>
            <div class="modal-body modal-body-sm text-center">
                <div class="nk-modal py-4">
                    <em class="nk-modal-icon icon icon-circle icon-circle-xxl ni ni-check bg-primary"></em>
                    <h4 class="nk-modal-title">Are You Sure ?</h4>
                    <div class="nk-modal-text mt-n2">
                        <p class="text-soft">This loan status will be changed to approved.</p>
                    </div>
                    <ul class="d-flex justify-content-center gx-4 mt-4">
                        
                        <form action="{% url 'approve' pk=loan.id %}" method="POST">
                    
                            {% csrf_token %}
                        <li>
                            <button type="submit" data-bs-dismiss="modal" id="deleteWH" class="btn btn-primary">Yes, Approve </button>
                        </li>
                        </form>
                        <li>
                            <button data-bs-dismiss="modal" data-toggle="modal" data-target="#editEventPopup" class="btn btn-danger btn-dim">Cancel</button>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div><!-- .Approve Loan Modal-content -->
<div class="modal fade" id="rejectLoan">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <a href="#" class="close" data-bs-dismiss="modal"><em class="icon ni ni-cross"></em></a>
            <div class="modal-body modal-body-sm text-center">
                <div class="nk-modal py-4">
                    <em class="nk-modal-icon icon icon-circle icon-circle-xxl ni ni-cross bg-danger"></em>
                    <h4 class="nk-modal-title">Are You Sure ?</h4>
                    <div class="nk-modal-text mt-n2">
                        <p class="text-soft">This loan status will be changed to rejected.</p>
                    </div>
                    <ul class="d-flex justify-content-center gx-4 mt-4">
                        <form action="{% url 'reject' loan.id %}" method="POST">
                            {% csrf_token %}
                        <li>
                            <button type="submit" data-bs-dismiss="modal" id="deleteWH" class="btn btn-primary">Yes, Reject </button>
                        </li>
                        </form>
                        <li>
                            <button data-bs-dismiss="modal" data-toggle="modal" data-target="#editEventPopup" class="btn btn-danger btn-dim">Cancel</button>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div><!-- .Reject Loan Modal-content -->
<div class="modal fade" id="addCollateral">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <a href="#" class="close" data-bs-dismiss="modal" aria-label="Close">
                <em class="icon ni ni-cross-sm"></em>
            </a>
            <div class="modal-body modal-body-md">
                <h5 class="modal-title">Add Collateral </h5><br>
            
                <form action="{% url 'add-collateral' pk=loan.id %}" class="form-validate" method="POST" enctype="multipart/form-data" >
                    {% csrf_token %}
                    <div class="row g-4">
                       <!-- <div class="col-lg-6">
                            <div class="form-group">
                                <label class="form-label" for="full-name-1">ID</label>
                                <div class="form-control-wrap">
                                    {{form_collateral.loan_id}}
                                </div>
                            </div>
                        </div> -->
                        <div class="col-lg-6">
                            <div class="form-group">
                                <label class="form-label" for="full-name-1">Name</label>
                                <div class="form-control-wrap">
                                    <!-- <input type="text" class="form-control" id="full-name-1" name="name"> -->
                                    {{form_collateral.name}}
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="form-group">
                                <label class="form-label" for="full-name-1">Type</label>
                                <div class="form-control-wrap">
                                    <!-- <input type="text" class="form-control" id="full-name-1" name="name"> -->
                                    {{form_collateral.type}}
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="form-group">
                                <label class="form-label" for="full-name-1">Serial No.</label>
                                <div class="form-control-wrap">
                                    <!-- <input type="text" class="form-control" id="full-name-1" name="name"> -->
                                    {{form_collateral.serial_number}}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label" for="fv-phone">Estimated Value</label>
                                <div class="form-control-wrap">
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text" id="fv-phone">{{company_currency}}</span>
                                        </div>
                                        {{form_collateral.estimated_value}}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="form-group">
                                <button type="submit" class="btn btn-lg btn-primary">Save</button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div><!-- .Add Collateral Modal-Content -->
<div class="modal fade" id="editCollateral">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <a href="#" class="close" data-bs-dismiss="modal" aria-label="Close">
                <em class="icon ni ni-cross-sm"></em>
            </a>
            <div class="modal-body modal-body-md">
                <h5 class="modal-title">Edit Collateral </h5><br>
                {% for collateral in collaterals %}
                <form action="{% url 'edit-collateral' collateral.id %}" class="form-validate" method="POST" enctype="multipart/form-data" >
                {% endfor %}
                    {% csrf_token %}
                    <div class="row g-4">
                        <div class="col-lg-6">
                            <div class="form-group">
                                <label class="form-label" for="full-name-1">ID</label>
                                <div class="form-control-wrap">
                                    <!-- <input type="text" class="form-control" id="full-name-1" name="name"> -->
                                    {{form_collateral.loan_id}}
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="form-group">
                                <label class="form-label" for="full-name-1">Name</label>
                                <div class="form-control-wrap">
                                    <!-- <input type="text" class="form-control" id="full-name-1" name="name"> -->
                                    {{form_collateral.name}}
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="form-group">
                                <label class="form-label" for="full-name-1">Type</label>
                                <div class="form-control-wrap">
                                    <!-- <input type="text" class="form-control" id="full-name-1" name="name"> -->
                                    {{form_collateral.type}}
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="form-group">
                                <label class="form-label" for="full-name-1">Serial No.</label>
                                <div class="form-control-wrap">
                                    <!-- <input type="text" class="form-control" id="full-name-1" name="name"> -->
                                    {{form_collateral.serial_number}}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label" for="fv-phone">Estimated Value</label>
                                <div class="form-control-wrap">
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text" id="fv-phone">{{company_currency}}</span>
                                        </div>
                                        {{form_collateral.estimated_value}}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="form-group">
                                <button type="submit" class="btn btn-lg btn-primary">Save</button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div><!-- .edit Collateral Modal-Content -->
<div class="modal fade" id="addRepayment">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <a href="#" class="close" data-bs-dismiss="modal" aria-label="Close">
                <em class="icon ni ni-cross-sm"></em>
            </a>
            <div class="modal-body modal-body-md">
                <h5 class="modal-title">Add Repaymemt </h5><br>
            
                <form action="{% url 'add-repayment' pk=loan.id %}" method="POST">
                    {% csrf_token %}
                    <div class="row g-4">
                        <div class="col-lg-6">
                            <div class="form-group">
                                <label class="form-label" for="full-name-1">Transaction ID</label>
                                <div class="form-control-wrap">
                                    {{form_repayment.transaction_id}}
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="form-group">
                                <label class="form-label" for="phone-no-1">Amount</label>
                                <div class="form-control-wrap">
                                    {{form_repayment.amount}}
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="form-group">
                                <label class="form-label" for="pay-amount-1">Date Paid</label>
                                <div class="form-control-wrap">
                                    {{form_repayment.date_paid}}
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-12">
                            <div class="form-group">
                                <button type="submit" class="btn btn-lg btn-primary">Save Payment</button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div><!-- .Add Repayment  Modal-Content -->
<div class="modal fade" id="removeGuarantor">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <a href="#" class="close" data-bs-dismiss="modal"><em class="icon ni ni-cross"></em></a>
            <div class="modal-body modal-body-sm text-center">
                <div class="nk-modal py-4">
                    <em class="nk-modal-icon icon icon-circle icon-circle-xxl ni ni-cross bg-danger"></em>
                    <h4 class="nk-modal-title">Are You Sure ?</h4>
                    <div class="nk-modal-text mt-n2">
                        <p class="text-soft">This guarantor will be removed permanently.</p>
                    </div>
                    <ul class="d-flex justify-content-center gx-4 mt-4">
                        <form id="delete-form" method="POST">
                            {% csrf_token %}
                        <li>
                            <button type="submit" data-bs-dismiss="modal" id="deleteObj" class="btn btn-primary">Yes, Delete it</button>
                        </li>
                        </form>
                        <li>
                            <button data-bs-dismiss="modal" data-toggle="modal" data-target="#editEventPopup" class="btn btn-danger btn-dim">Cancel</button>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div><!-- .Delete member Modal-content -->

<div class="modal fade" id="removeCollateral">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <a href="#" class="close" data-bs-dismiss="modal"><em class="icon ni ni-cross"></em></a>
            <div class="modal-body modal-body-sm text-center">
                <div class="nk-modal py-4">
                    <em class="nk-modal-icon icon icon-circle icon-circle-xxl ni ni-cross bg-danger"></em>
                    <h4 class="nk-modal-title">Are You Sure ?</h4>
                    <div class="nk-modal-text mt-n2">
                        <p class="text-soft">This collateral will be removed permanently.</p>
                    </div>
                    <ul class="d-flex justify-content-center gx-4 mt-4">
                        <form id="delete-form" method="POST">
                            {% csrf_token %}
                        <li>
                            <button type="submit" data-bs-dismiss="modal" id="deleteObj" class="btn btn-primary">Yes, Delete it</button>
                        </li>
                        </form>
                        <li>
                            <button data-bs-dismiss="modal" data-toggle="modal" data-target="#editEventPopup" class="btn btn-danger btn-dim">Cancel</button>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div><!-- .Delete member Modal-content -->

<!--
    rendering the modal dynamically using JavaScript/jQuery to add 
    the branch.id to the form action URL when the user clicks on 
    the "Delete Branch" button.
-->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
//-- deleteRole modal script
function showDeleteModalForm() {
    // Implementation of showModalForm() to display the modal
    $('#removeGuarantor').modal('show');
}

    $(document).ready(function() {
    // Get all the delete buttons
    var deleteButtons = document.getElementsByClassName('delete-button');

    // Loop through each delete button
    for (var i = 0; i < deleteButtons.length; i++) {
        // Add click event listener
        deleteButtons[i].addEventListener('click', function() {
            // Get the pk from the data attribute
            var guarantor_id = this.dataset.pk;
            var loan_id = this.dataset.loan_id

            // Update the form's action with the correct URL
            // Replace '0' with the actual value of pk from your Django template context
            var form = document.getElementById('delete-form');
            form.action = '{% url "remove-guarantor" 0 1 %}'.replace('0', loan_id).replace('1', guarantor_id);

            // Display the modal form
            // Assuming you have code to display the modal form
            showDeleteModalForm();

            // You can add additional logic here if needed, e.g., pre-fill form fields, etc.

            // Let the user manually click the submit button
            // Assuming you have a submit button with id 'delete-submit-button'
            document.getElementById('deleteObj').addEventListener('click', function() {
                // Submit the form
                form.submit();
            });
        });
    }
});
//-- ends

//-- remove collateral 
function showDeleteModalForm() {
    // Implementation of showModalForm() to display the modal
    $('#removeCollateral').modal('show');
}

    $(document).ready(function() {
    // Get all the delete buttons
    var deleteButtons = document.getElementsByClassName('delete-button');

    // Loop through each delete button
    for (var i = 0; i < deleteButtons.length; i++) {
        // Add click event listener
        deleteButtons[i].addEventListener('click', function() {
            // Get the pk from the data attribute
            var collateral_id = this.dataset.pk;
            var loan_id = this.dataset.loan_id

            // Update the form's action with the correct URL
            // Replace '0' with the actual value of pk from your Django template context
            var form = document.getElementById('delete-form');
            form.action = '{% url "remove-collateral" 0 1 %}'.replace('0', loan_id).replace('1', collateral_id);

            // Display the modal form
            // Assuming you have code to display the modal form
            showDeleteModalForm();

            // You can add additional logic here if needed, e.g., pre-fill form fields, etc.

            // Let the user manually click the submit button
            // Assuming you have a submit button with id 'delete-submit-button'
            document.getElementById('deleteObj').addEventListener('click', function() {
                // Submit the form
                form.submit();
            });
        });
    }
});
//-- ends
</script> 
<script>
    setTimeout(function(){
        if ($('#msg').length > 0) {
            $('#msg').remove();
        }
    }, 6000)    // 10000 millisecond
</script>
{% endblock content %}